var request = require('request');
//var S = require('string');
var aws = require("aws-lib");
var fs = require("fs");
prodAdv = aws.createProdAdvClient("AKIAI43V7ZBTTCPVKXGA", "2IR0LjNM9I77lLWe4U9BPPnC2k8hq+oK7ULNGGj2", "p07957-20");
var self = module.exports;

self.searchItems = function(params, callback) {

	prodAdv.call("ItemSearch", {SearchIndex: params.category, Keywords: params.keywords, ResponseGroup: "OfferSummary, Images, ItemAttributes"}, function(err, result) {
    if (err){
     if (callback) callback(new Error("Error getting search"), null);
   }

   try{

    resultClean = {};
    resultClean.Amount = 9999999 ;
fs.writeFile("logs/resultAmazon.txt", JSON.stringify(result, null, 4));
    result.Items.Item.forEach(function(item){      
      if(parseInt(item.OfferSummary.LowestNewPrice.Amount) < resultClean.Amount){
      resultClean.salePrice = item.OfferSummary.LowestNewPrice.FormattedPrice; //TODO slice that bitch
      resultClean.store = "amazon";
      resultClean.manufacturer = item.ItemAttributes.Manufacturer;
      resultClean.name = item.ItemAttributes.Title;
      resultClean.thumbnailImage = item.SmallImage.URL;
      resultClean.url = item.ItemLinks.ItemLink[0].URL;
      console.log(JSON.stringify(resultClean));
    }

    });
    
    result = resultClean;

  }catch(err){
    console.log("Amazon item non trouve !!!!!!!" +err);
  }
  if (callback) callback(null, result);
});
};
function predicatBy(prop){
 return function(a,b){
  if( a[prop] > b[prop]){
    return 1;
  }else if( a[prop] < b[prop] ){
    return -1;
  }
  return 0;
}
}
